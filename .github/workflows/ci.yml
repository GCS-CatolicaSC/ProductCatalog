name: CI do Catálogo de Produtos

# Gatilhos: Executa em pushes para 'master' ou 'feature/*'
# e em pull requests abertos contra 'master'
on:
  push:
    branches: ["master", "feature/**"]
  pull_request:
    branches: ["master"]

jobs:
  build-and-test:
    # Usamos a versão mais recente do Ubuntu
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do código
      - name: Checkout do repositório
        uses: actions/checkout@v4

      # --- ETAPA DO BACKEND (.NET) ---

      # 2. Configurar o .NET SDK (baseado nos seus arquivos .csproj)
      - name: Setup .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # 3. Cache dos pacotes NuGet
      - name: Cache de pacotes NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # 4. Restaurar dependências .NET (Individualmente)
      #    Isso evita o problema de case-sensitivity no .sln
      - name: Restaurar dependências .NET
        run: |
          dotnet restore ProductCatalog.Api/ProductCatalog.Api.csproj
          dotnet restore ProductCatalog.Tests/ProductCatalog.Tests.csproj

      # 5. Construir a solução .NET
      - name: Build .NET
        run: dotnet build ProductCatalog.sln --configuration Release --no-restore

      # 6. Executar os testes .NET
      - name: Executar testes .NET
        run: dotnet test ProductCatalog.Tests/ProductCatalog.Tests.csproj --configuration Release --no-build

      # --- ETAPA DO FRONTEND (Node.js) ---

      # 7. Configurar o Node.js 20
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 8. Cache dos pacotes NPM
      - name: Cache de módulos Node (npm)
        uses: actions/cache@v4
        with:
          # O cache do npm fica em ~/.npm
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('productcatalog.app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 9. Instalar dependências do frontend (usando 'npm ci' para builds de CI)
      - name: Instalar dependências do Frontend
        run: npm ci
        working-directory: ./productcatalog.app

      # 10. Buildar o projeto frontend (Vite)
      - name: Build Frontend
        run: npm run build
        working-directory: ./productcatalog.app
